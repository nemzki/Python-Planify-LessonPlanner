{% extends "base.html" %}
{% block title %}Contact Messages{% endblock %}

{% block content %}
<div class="admin-messages-page">

    <!-- Page Header -->
    <div class="messages-page-header">
        <div class="header-left-section">
            <a href="{{ url_for('admin_home') }}" class="back-icon-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                     stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </a>
            <div>
                <h1>Contact Messages</h1>
                <p class="header-subtitle">View and manage messages from users</p>
            </div>
        </div>
        <div class="unread-badge-header">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                <polyline points="22,6 12,13 2,6"/>
            </svg>
            {{ unread_count }} Unread
        </div>
    </div>

    {% if messages %}
    <!-- Messages List -->
    <div class="messages-list-container">
        {% for message in messages %}
        <div class="message-list-item {% if not message.is_read %}unread-item{% endif %}"
             onclick="openMessageModal({{ message.id }})">

            <!-- Icon -->
            <div class="message-item-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                    <polyline points="22,6 12,13 2,6"/>
                </svg>
            </div>

            <!-- Message Info -->
            <div class="message-item-info">
                <div class="message-item-header">
                    <h3>{{ message.name or 'Anonymous' }}</h3>
                    {% if not message.is_read %}
                    <span class="new-indicator">NEW</span>
                    {% endif %}
                </div>
                <p class="message-item-email">{{ message.email }}</p>
                <p class="message-item-preview">{{ message.message[:80] }}{% if message.message|length > 80 %}...{%
                    endif %}</p>
            </div>

            <!-- Date & Arrow -->
            <div class="message-item-meta">
                <span class="message-item-date">{{ message.created_at.strftime('%b %d, %Y') }}</span>
                <svg class="arrow-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                     stroke-width="2">
                    <polyline points="9 18 15 12 9 6"/>
                </svg>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-messages-state">
        <div class="empty-icon">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                <polyline points="22,6 12,13 2,6"/>
            </svg>
        </div>
        <h3>No Messages Yet</h3>
        <p>You haven't received any contact messages.</p>
    </div>
    {% endif %}

</div>

<!-- Modal for Reading Message -->
<div id="messageModal" class="message-modal">
    <div class="message-modal-overlay" onclick="closeMessageModal()"></div>
    <div class="message-modal-content">
        <div class="modal-header">
            <h2 id="modalSenderName">Sender Name</h2>
            <button class="modal-close-btn" onclick="closeMessageModal()">Ã—</button>
        </div>

        <div class="modal-body">
            <div class="modal-info-row">
                <span class="modal-label">From:</span>
                <span id="modalSenderEmail" class="modal-value">email@example.com</span>
            </div>
            <div class="modal-info-row">
                <span class="modal-label">Date:</span>
                <span id="modalDate" class="modal-value">Dec 08, 2025</span>
            </div>
            <div class="modal-divider"></div>
            <div class="modal-message-content">
                <p id="modalMessageContent">Message content here...</p>
            </div>
        </div>

        <div class="modal-footer">
            <form id="markReadForm" method="POST" style="display:inline;">
                <button type="submit" class="modal-btn-mark">Mark as Read</button>
            </form>
            <form id="deleteForm" method="POST" onsubmit="return confirm('Delete this message?');"
                  style="display:inline;">
                <button type="submit" class="modal-btn-delete">Delete</button>
            </form>
        </div>
    </div>
</div>

<script>
    // Message data stored in JavaScript
    const messagesData = {
        {% for message in messages %}
        {{ message.id }}: {
            name: "{{ message.name or 'Anonymous' }}",
            email: "{{ message.email }}",
            date: "{{ message.created_at.strftime('%b %d, %Y at %I:%M %p') }}",
            message: {{ message.message|tojson }},
            isRead: {{ message.is_read|tojson|lower }},
            markReadUrl: "{{ url_for('mark_message_read', message_id=message.id) }}",
            deleteUrl: "{{ url_for('delete_message', message_id=message.id) }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    };

    function openMessageModal(messageId) {
        const data = messagesData[messageId];

        document.getElementById('modalSenderName').textContent = data.name;
        document.getElementById('modalSenderEmail').textContent = data.email;
        document.getElementById('modalDate').textContent = data.date;
        document.getElementById('modalMessageContent').textContent = data.message;

        document.getElementById('markReadForm').action = data.markReadUrl;
        document.getElementById('deleteForm').action = data.deleteUrl;

        // Show/hide Mark as Read button
        const markBtn = document.getElementById('markReadForm');
        if (data.isRead) {
            markBtn.style.display = 'none';
        } else {
            markBtn.style.display = 'inline';
        }

        document.getElementById('messageModal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeMessageModal() {
        document.getElementById('messageModal').classList.remove('active');
        document.body.style.overflow = 'auto';
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeMessageModal();
        }
    });
</script>

{% endblock %}